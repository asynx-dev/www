# We have 2 build steps, one for deployment and one for before merging PRs.
#
# By using 'if's, deploy build only runs on master branch and when the request
# isn't a PR. This runs if a maintainer accepts a PR and it is used to deploy
# the site to public
#
# merge build runs for PRs on master branch. This runs when a developer opens
# a PR. This runs operate on the code as if the PR is merged.
#
# It is assumed that the master branch is protected and no one can push directly.
# All changes on the master branch should be done with PRs. Thus, for each change
# it is guaranteed that tests run before deploying to public. We don't have
# separate "branch" and "PR run" for each PR, we enable only "PR run".
#
# To understand how the mechanism works, please check:
#
# https://stackoverflow.com/a/47706402/1766391
# https://docs.travis-ci.com/user/conditional-builds-stages-jobs/#Conditional-Builds
# https://docs.travis-ci.com/user/conditions-v1


jobs:
  include:
  - name: deploy_build
    language: python
    python:
      - "3.6"
    if: (branch=master) AND (type IN (push, api, cron))
    install:
    - pip3 install pipenv
    script:
    - python3 build-deploy.py
    - python3 test.py pytest
    deploy:
      provider: pages
      local_dir: site
      skip_cleanup: true
      keep_history: false
      cleanup: false
      deployment_file: true
      verbose: true
      github_token: "$GITHUB_TOKEN"
  - name: merge_build
    language: python
    python:
      - "3.6"
    if: (branch=master) AND (type IN (pull_request))
    install:
    - pip3 install pipenv
    script:
    - python3 build-merge.py
    - python3 test.py pytest
  - name: markdown_lint
    language: node_js
    if: (branch=master) AND (type IN (pull_request))
    node_js:
    - node
    before_script:
    - npm install -g markdownlint-cli
    script:
    - markdownlint ./ docs
notifications:
  slack:
    rooms:
      secure: fNuQ8q7R/iK3dKPzrhBH47u7JEpqRZUO+JE/8lK2JfwlNPKU9v8cdFTjP/csKnrzkXRVLgeditJ2woMb4Yb/abWPlqeG6UCavq4IaCnTjTw2wGYel6k9y68BZnZhW9ypgmrI9egVIDWfwRoh/8QwkCGWMG+ufxrXzd//T+H8TPkeuLgLb6A3hjceHnsTJRMTOsJJYsyAbOaHhQD++KPzIinZOh+jYu96NBk5bCAnESyV/MPofb3ZS2V3YNxFygaWI1Oeox/u/I+UzZ3JcqBenXF0GdquyH0tYB34COqsRZhd+sVM7fmJQZ+ylgpZmRFoy5YbBBkEDGzEShcp+Xet5ar093rRQhVO2rk/cwnlS4/AuS/P2CY8v5yqYDhEpgjFZEEIRZ6rAkwz7D8MKbemvPSb82tisObwYKl8eoz6CvmCkWnylshBKxcmdcsSJoQau1TlkpNfxjbSOr4r/TJZbmokorvPoF4eIMQmRJjq2H/q8SIV4H8z1hhXKCfrzgN4v37AwnaEiST6vrRbw0X0yOVl8YZrNKPM60RdEr65oZfvrO5eW1Qy1DqY6TJSBgscGKd1Y9lLweL1rb57/X4Oy/JuxYGvuAiRqTCz5C73UPeK5TIEfuYkwWqefcmzwH5yQ5FiRfTtuf0F7BfmZCBQt9+n8I4bnb4sESIOhdXZeac=
